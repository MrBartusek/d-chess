"use strict";(()=>{var E=class{constructor(){this.state=new Array(63).fill(null)}getByPosition(t,e){if(t<0||t>7||e<0||e>7)throw new RangeError("x or y argument out of range");return this.state[t+e*8]}getByIndex(t){return this.state[t]}setByPosition(t,e,r){let o=this.getByPosition(t,e);return this.state[t+e*8]=r,o}setByIndex(t,e){let r=this.getByIndex(t);return this.state[t]=e,r}setAll(t){if(t.length!==63)throw new Error("Board must have exactly 63 pieces.");this.state=t}reset(){this.state=new Array(63).fill(null)}};var l=class{constructor(t){this._color=t}get color(){return this._color}onMove(t,e){}};var m=class{};var a=class extends m{constructor(e){super();this.direction=e}computeMoves(e,r){let o=[],n=r;for(;n>=0&&n<=63;){o.push(n);let s=this.calculateStepDiff()+n;if(this.isEdgeCase(n,s))break;n=s;let u=e.getByIndex(n);if(u!=null){let p=e.getByIndex(r);u.color!=p.color&&o.push(n);break}}return o}calculateStepDiff(){switch(this.direction){case"TOP":return-8;case"TOP_RIGHT":return-7;case"RIGHT":return 1;case"BOTTOM_RIGHT":return 9;case"BOTTOM":return 8;case"BOTTOM_LEFT":return 7;case"LEFT":return-1;case"TOP_LEFT":return-9;default:throw new Error("Invalid slide direction")}}isEdgeCase(e,r){let o=Math.floor(e/8),n=Math.floor(r/8);switch(this.direction){case"LEFT":case"RIGHT":return o!==n;case"TOP_LEFT":case"BOTTOM_LEFT":return r%8===7;case"TOP_RIGHT":case"BOTTOM_RIGHT":return r%8===0;default:return!1}}};var d=class extends l{constructor(e){super(e);this._color=e}get type(){return"bishop"}get image(){return`${this.color}Bishop.png`}get materialValue(){return 3}get isKing(){return!1}get moves(){return[new a("TOP_LEFT"),new a("TOP_RIGHT"),new a("BOTTOM_LEFT"),new a("BOTTOM_RIGHT")]}};var i=class extends m{constructor(e,r={}){super();this.step=e;this.options=r}computeMoves(e,r){let o=r+this.step,n=r%8,s=o%8;if(Math.abs(n-s)>2)return[];if(o>=0&&o<=63){let u=this.options.canCapture??!0;if(e.getByIndex(o)!=null&&!u)return[];let p=this.options.onlyCapture??!1;return e.getByIndex(o)==null&&p?[]:[o]}return[]}};var g=class extends l{constructor(e){super(e);this._color=e}get type(){return"king"}get image(){return`${this.color}King.png`}get materialValue(){return 0}get isKing(){return!0}get moves(){return[new i(-9),new i(-8),new i(-7),new i(-1),new i(1),new i(7),new i(8),new i(9)]}};var h=class extends l{constructor(e){super(e);this._color=e}get type(){return"knight"}get image(){return`${this.color}Knight.png`}get materialValue(){return 3}get isKing(){return!1}get moves(){return[new i(17),new i(15),new i(10),new i(6),new i(-17),new i(-15),new i(-10),new i(-6)]}};var B=class extends m{constructor(e){super();this.step=e}computeMoves(e,r){let o=r+this.step,n=r+this.step/2,s=e.getByIndex(n),u=e.getByIndex(o);return s==null&&u==null?[o]:[]}};var f=class extends m{constructor(e){super();this.step=e}computeMoves(e,r){let o=r+this.step,n=e.getByIndex(this.step>0?o-8:o+8);return n instanceof T&&n.canEnPassant?[o]:[]}};var T=class extends l{constructor(e){super(e);this._color=e;this.moved=!1;this._canEnPassant=!1}get type(){return"pawn"}get image(){return`${this.color}Pawn.png`}get isKing(){return!1}get canEnPassant(){return this._canEnPassant}get moves(){let e=[];return this._color=="white"?(e.push(new i(-8,{canCapture:!1})),e.push(new i(-7,{onlyCapture:!0})),e.push(new i(-9,{onlyCapture:!0})),this.moved||e.push(new B(-16)),e.push(new f(-7)),e.push(new f(-9))):(e.push(new i(8,{canCapture:!1})),e.push(new i(7,{onlyCapture:!0})),e.push(new i(9,{onlyCapture:!0})),this.moved||e.push(new B(16)),e.push(new f(7)),e.push(new f(9))),e}get materialValue(){return 1}onMove(e,r){if(!this.moved&&(this.moved=!0,Math.abs(e-r)==16)){this._canEnPassant=!0;return}this._canEnPassant=!1}};var v=class extends l{constructor(e){super(e);this._color=e}get type(){return"queen"}get image(){return`${this.color}Queen.png`}get materialValue(){return 9}get isKing(){return!1}get moves(){return[new a("TOP_LEFT"),new a("TOP_RIGHT"),new a("RIGHT"),new a("BOTTOM_RIGHT"),new a("BOTTOM"),new a("BOTTOM_LEFT"),new a("LEFT"),new a("TOP")]}};var b=class extends l{constructor(e){super(e);this._color=e}get type(){return"rook"}get image(){return`${this.color}Rook.png`}get materialValue(){return 5}get isKing(){return!1}get moves(){return[new a("TOP"),new a("RIGHT"),new a("BOTTOM"),new a("LEFT")]}};var w=class{static playMove(){return this.play("move.mp3")}static playCapture(){return this.play("capture.mp3")}static play(t){new Audio(`static/sounds/${t}`).play()}};var M=class{constructor(){this.currentTurn="white";this.state="STARTED";this.board=new E,this.capturedPieces={white:[],black:[]}}setDefaultBoard(){this.board.setByPosition(0,0,new b("black")),this.board.setByPosition(1,0,new h("black")),this.board.setByPosition(2,0,new d("black")),this.board.setByPosition(3,0,new v("black")),this.board.setByPosition(4,0,new g("black")),this.board.setByPosition(5,0,new d("black")),this.board.setByPosition(6,0,new h("black")),this.board.setByPosition(7,0,new b("black")),this.board.setByPosition(0,7,new b("white")),this.board.setByPosition(1,7,new h("white")),this.board.setByPosition(2,7,new d("white")),this.board.setByPosition(3,7,new v("white")),this.board.setByPosition(4,7,new g("white")),this.board.setByPosition(5,7,new d("white")),this.board.setByPosition(6,7,new h("white")),this.board.setByPosition(7,7,new b("white"));let t=8;for(let e=0;e<8;e++)this.board.setByIndex(1*t+e,new T("black")),this.board.setByIndex(6*t+e,new T("white"))}setStalemateTestBoard(){this.board.setByPosition(0,0,new g("black")),this.board.setByPosition(5,1,new v("black")),this.board.setByPosition(6,7,new g("white"))}restart(){this.board.reset(),this.currentTurn="white",this.state="STARTED"}getBoard(){return this.board}getState(){return this.state}getCapturedPieces(){return Object.assign({},this.capturedPieces)}calculateTotalMaterial(t){return this.getCapturedPieces()[t].map(r=>r.materialValue).reduce((r,o)=>r+o,0)}canMakeMove(t,e){if(this.state!="STARTED")return!1;let r=this.board.getByIndex(t);if(!r)throw new Error("Invalid fromTile - field is empty");let o=this.board.getByIndex(e);return t==e||r.color!=this.currentTurn||o&&o.color==r.color||this.isEndgameMove(r,e)?!1:this.computeMoves(t).includes(e)}listMoves(t){return this.computeMoves(t).filter(r=>this.canMakeMove(t,r))}makeMove(t,e){if(!this.canMakeMove(t,e)){console.warn(`Illegal move! ${t} -> ${e}`);return}let r=this.board.getByIndex(t),o=this.board.getByIndex(e);if(o&&o.isKing){console.warn(`Cant capture this piece! ${t} -> ${e}`);return}if(r.type=="pawn"&&Math.abs(t-e)%8>0&&o==null){let p=r.color=="white"?8:-8,C=e+p;o=this.board.getByIndex(C),this.board.setByIndex(C,null),console.log("google en passant",{fromTile:t,toTile:e,targetedPawnPosition:C})}this.board.setByIndex(t,null),this.board.setByIndex(e,r),o!=null?(w.playCapture(),this.capturedPieces[this.getCurrentTurn()].push(o)):w.playMove(),r.onMove(t,e),r.type=="pawn"&&this.isLastRow(e,r.color)&&this.promotePawn(e),this.currentTurn=this.getNextTurn(),this.updateGameState(),console.log(`Completed move!  ${t} -> ${e}`)}getCurrentTurn(){return this.currentTurn}getNextTurn(){return this.currentTurn=="white"?"black":"white"}computeMoves(t){let e=this.board.getByIndex(t);if(!e)throw new Error("Invalid fromTile - field is empty");return e.moves.flatMap(r=>r.computeMoves(this.board,t))}isLastRow(t,e){let r=Math.floor(t/8);return e=="white"?r==0:r==8}promotePawn(t){let e=this.board.getByIndex(t);if(e?.type!="pawn")throw new Error("Cannot promote non-pawn piece");this.board.setByIndex(t,new v(e.color))}isEndgameMove(t,e){if(!t.isKing)return!1;for(let r=0;r<64;r++){if(e==r)continue;let o=this.board.getByIndex(r);if(!o||o.color==t.color)continue;if(this.computeMoves(r).includes(e))return!0}return!1}updateGameState(){let t={white:!1,black:!1},e={white:!1,black:!1};for(let r=0;r<64;r++){let o=this.board.getByIndex(r);if(!o)continue;let n=this.listMoves(r);for(let s of n){let u=this.board.getByIndex(s);e[o.color]=!0,u&&u.isKing&&(t[u.color]=!0)}}this.currentTurn=="black"?t.white?this.state="BLACK_WIN":e.black||(this.state="STALEMATE"):this.currentTurn=="white"&&(t.black?this.state="WHITE_WIN":e.white||(this.state="STALEMATE"))}};var y=class{drawBoard(t){let e=[];for(let r=0;r<64;r++){let o=t.getByIndex(r),n=document.getElementById(`tile-${r}`),s=this.getPieceElement(n);if(s&&o){if(s.classList.contains(o.type)&&s.classList.contains(o.color)){e.push(s);continue}s.remove()}if(s&&!o)s.remove();else if(o){let u=`static/img/pieces/${o.image}`,p=this.createPiece(u,o.type,o.color);n.appendChild(p),e.push(p)}}return e}generateBoard(t){for(let e=0;e<8;e++){let r=this.createRow(e);t.appendChild(r);for(let o=0;o<8;o++){let n=this.createTile(e,o);if(r.appendChild(n),o==0){let s=this.createNotation(`${e+1}`,"notation-top");n.appendChild(s)}if(e==7){let s=["a","b","c","d","e","f","g","h"],u=this.createNotation(s[o],"notation-bot");n.appendChild(u)}}}}createRow(t){let e=document.createElement("div");return e.classList.add("row"),e.id=`row-${t}`,e}createTile(t,e){let r=document.createElement("div");return r.classList.add("tile"),r.id=`tile-${t*8+e}`,(t+e)%2&&r.classList.add("tile-variant"),r}createNotation(t,e){let r=document.createElement("div");return r.classList.add("notation",e),r.textContent=t,r}createPiece(t,e,r){let o=document.createElement("img");return o.classList.add("piece",e,r),o.src=t,o.draggable=!1,o}getPieceElement(t){let e=t.getElementsByClassName("piece");return e.length>0?e[0]:null}};var I=class{drawPlayers(t){for(let e of["white","black"]){let r=document.getElementById(`${e}-next-move`);r.style.display=t.getCurrentTurn()==e?"inline-block":"none";let o=document.getElementById(`${e}-material-pieces`),n=t.getCapturedPieces()[e];o.replaceChildren(...n.map(this.generateMaterialPiece));let s=document.getElementById(`${e}-material-value`),u=t.calculateTotalMaterial(e);s.innerText=`(${u>0?"+":""}${u})`}}generateMaterialPiece(t){let e=document.createElement("img");return e.src=`static/img/pieces/${t.image}`,e.className="material-piece",e}};var L=class{constructor(t){this.currentDraggedPiece=null;this.dragStartX=0;this.dragStartY=0;this.game=t,this.boardGenerator=new y,this.playerGenerator=new I,this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onStartDragging=this.onStartDragging.bind(this)}start(){let t=document.getElementById("board");this.boardGenerator.generateBoard(t),this.drawUi(this.game.getBoard())}drawUi(t){this.drawBoard(t),this.playerGenerator.drawPlayers(this.game)}drawBoard(t){let e=this.boardGenerator.drawBoard(t);for(let r of e)r.removeEventListener("mousedown",this.onStartDragging),r.addEventListener("mousedown",this.onStartDragging)}onStartDragging(t){this.currentDraggedPiece=t.target,this.currentDraggedPiece.classList.add("dragged"),this.dragStartX=t.clientX,this.dragStartY=t.clientY;let e=this.getTileFromDraggedPiece(),r=this.game.listMoves(e);for(let o of r)this.addHighlight(o);document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}onMouseMove(t){let e=t.clientX-this.dragStartX,r=t.clientY-this.dragStartY;this.currentDraggedPiece&&(this.currentDraggedPiece.style.transform=`translate(${e}px, ${r}px)`)}onMouseUp(t){if(document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),this.removeAllHighlights(),this.currentDraggedPiece){let e=this.getTileFromDraggedPiece();this.currentDraggedPiece.style.transform="",this.currentDraggedPiece.classList.remove("dragged"),this.currentDraggedPiece=null;let r=this.getTileFromPoint(t.clientX,t.clientY);if(!r)return;let o=Number(r.id.replace("tile-",""));this.game.makeMove(e,o),this.drawUi(this.game.getBoard()),setTimeout(()=>{this.checkGameState()},100)}}checkGameState(){let t=this.game.getState();t!="STARTED"&&(t=="BLACK_WIN"?alert("Black won!"):t=="WHITE_WIN"?alert("White won!"):t=="STALEMATE"&&alert("Stalemate!"),this.game.restart(),this.game.setDefaultBoard(),this.drawUi(this.game.getBoard()))}getTileFromPoint(t,e){let r=document.elementFromPoint(t,e);if(!r)return;if(r.classList.contains("tile"))return r;let n=r.parentElement;return n.classList.contains("tile")?n:null}getTileFromDraggedPiece(){if(this.currentDraggedPiece)return Number(this.currentDraggedPiece.parentElement.id.replace("tile-",""))}addHighlight(t){let e=document.getElementById(`tile-${t}`);if(!e)throw new Error(`Invalid tile: ${t}`);let r=document.createElement("div");r.classList.add("highlighted"),e.getElementsByClassName("piece").length>0&&r.classList.add("highlighted-capture"),e.appendChild(r)}removeAllHighlights(){Array.from(document.getElementsByClassName("highlighted")).forEach(t=>t.remove())}};function D(){let c=new M;c.setDefaultBoard(),new L(c).start()}document.addEventListener("DOMContentLoaded",()=>D());})();
